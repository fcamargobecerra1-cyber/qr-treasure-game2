<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>QR Treasure Hunt</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  text-align: center;
  padding: 30px;
}
input, select, button {
  padding: 10px;
  margin: 6px;
}
#game, #rankingBox {
  display: none;
}
#reader {
  margin: auto;
  width: 300px;
}
</style>
</head>

<body>

<h1>ğŸ´â€â˜ ï¸ Treasure Hunt</h1>

<!-- LOGIN -->
<div id="login">
  <input id="name" placeholder="Jugador"><br>
  <input id="team" placeholder="Equipo"><br>

  <select id="route">
    <option value="">Selecciona ruta</option>
    <option value="A">Ruta A (1 â†’ 7 â†’ Final)</option>
    <option value="B">Ruta B (7 â†’ 1 â†’ Final)</option>
  </select><br>

  <button onclick="startGame()">Start</button>
</div>

<!-- GAME -->
<div id="game">
  <h2 id="playerInfo"></h2>
  <p id="time">â± 0 s</p>

  <h3>ğŸ“¥ QR manual</h3>
  <input id="qrInput" placeholder="CÃ³digo QR">
  <button onclick="scanQR()">Enviar</button>

  <h3>ğŸ“· CÃ¡mara</h3>
  <div id="reader"></div>
  <button onclick="startScanner()">Activar</button>
  <button onclick="stopScanner()">Detener</button>

  <h3>ğŸ§© Pista</h3>
  <div id="clue"></div>

  <h3>â­ Logros</h3>
  <ul id="trophies"></ul>
</div>

<!-- RANKING -->
<div id="rankingBox">
  <h2>ğŸ† Ranking</h2>
  <ol id="ranking"></ol>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCnbWVep308i-Bo12xeJJoo_VFPd9RJoOI",
  authDomain: "qr-treasure-game.firebaseapp.com",
  projectId: "qr-treasure-game",
  storageBucket: "qr-treasure-game.firebasestorage.app",
  messagingSenderId: "255665365234",
  appId: "1:255665365234:web:b0d76d1cbd6256849df06b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= VARIABLES ================= */
let player = "";
let team = "";
let route = "";
let startTime = 0;
let finished = false;
let scanner = null;

/* ================= RUTAS (SIN FINAL) ================= */
const ROUTES = {
  A: ["QR1","QR2","QR3","QR4","QR5","QR6","QR7"],
  B: ["QR7","QR6","QR5","QR4","QR3","QR2","QR1"]
};

/* ================= PISTAS ================= */
const clues = {
  QR1: "ğŸŒ² Estos baÃ±os estÃ¡n bloqueados por un Ã¡rbol, ahora son almacÃ©n",
  QR2: "â˜• Esta cafeterÃ­a tiene potencia, lÃ¡stima que estÃ© en obra negra",
  QR3: "ğŸ” AquÃ­ muriÃ³ la gallina Claudio",
  QR4: "ğŸ—¼ Esta torre se supone que da seÃ±al a Pirgua",
  QR5: "ğŸŒŠ La vecina tenÃ­a un lagoâ€¦ ahora estÃ¡ seco",
  QR6: "ğŸ—¿ Esas piedras en medioâ€¦ Â¿por quÃ© estarÃ¡n ahÃ­?",
  QR7: "ğŸŒ³ Este tronco es enorme, Â¿quÃ© tan grande fue antes?",
  QR8_FINAL: "ğŸ Â¡Meta final alcanzada!",

  BONUS_50: "ğŸŒŸ Logro escondido: -50 segundos",
  BONUS_30: "ğŸŒŸ Logro escondido: -30 segundos",
  WINNER_1: "â­ Ganador oculto: -60 segundos",
  WINNER_2: "â­ Ganador oculto: -60 segundos",
  WINNER_3: "â­ Ganador oculto: -60 segundos"
};

/* ================= LOGROS ================= */
const trophyNames = {
  QR1: "ğŸŒ² Explorador",
  QR2: "â˜• Cafetero",
  QR3: "ğŸ” Testigo",
  QR4: "ğŸ—¼ Conectado",
  QR5: "ğŸŒŠ NostÃ¡lgico",
  QR6: "ğŸ—¿ Curioso",
  QR7: "ğŸŒ³ LeÃ±ador",
  QR8_FINAL: "ğŸ Finalista",

  BONUS_50: "ğŸŒŸ Bonus -50s",
  BONUS_30: "ğŸŒŸ Bonus -30s",
  WINNER_1: "â­ Ganador oculto",
  WINNER_2: "â­ Ganador oculto",
  WINNER_3: "â­ Ganador oculto"
};

/* ================= INICIO ================= */
function startGame() {
  const nameInput = document.getElementById("name");
  const teamInput = document.getElementById("team");
  const routeInput = document.getElementById("route");

  player = nameInput.value.trim();
  team = teamInput.value.trim();
  route = routeInput.value;

  if (!player || !team || !route) {
    alert("Completa todos los campos");
    return;
  }

  startTime = Date.now();

  db.collection("games").doc(player).set({
    player,
    team,
    route,
    trophies: [],
    startTime,
    finished: false,
    time: 0
  });

  document.getElementById("login").style.display = "none";
  document.getElementById("game").style.display = "block";

  document.getElementById("playerInfo").innerText =
    `Jugador: ${player} | Equipo: ${team} | Ruta: ${route}`;

  setInterval(updateTime, 1000);
}

/* ================= TIEMPO ================= */
function updateTime() {
  if (finished) return;
  document.getElementById("time").innerText =
    `â± ${Math.floor((Date.now() - startTime) / 1000)} s`;
}

/* ================= ESCANEO ================= */
function scanQR() {
  if (finished) return;

  const qr = document.getElementById("qrInput").value.trim();
  if (!qr) return;

  /* ===== BONUS Y LOGROS OCULTOS ===== */
  if (qr.startsWith("BONUS") || qr.startsWith("WINNER")) {
    if (qr === "BONUS_50") startTime -= 50000;
    if (qr === "BONUS_30") startTime -= 30000;
    if (qr.startsWith("WINNER")) startTime -= 60000;

    document.getElementById("clue").innerText = clues[qr];
    return;
  }

  const ref = db.collection("games").doc(player);

  ref.get().then(doc => {
    const data = doc.data();
    const routeList = ROUTES[data.route];

    /* ===== FINAL ===== */
    if (qr === "QR8_FINAL") {
      if (data.trophies.length !== routeList.length) {
        alert("âŒ AÃºn no completas todas las pistas");
        return;
      }

      finished = true;
      data.finished = true;
      data.time = Math.floor((Date.now() - startTime) / 1000);

      ref.update(data);
      document.getElementById("clue").innerText = clues[qr];
      document.getElementById("rankingBox").style.display = "block";
      loadRanking();
      return;
    }

    /* ===== RUTA NORMAL ===== */
    const expected = routeList[data.trophies.length];

    if (qr !== expected) {
      alert("âŒ QR incorrecto para esta ruta");
      return;
    }

    data.trophies.push(qr);

    ref.update(data);
    document.getElementById("clue").innerText = clues[qr];
    renderTrophies(data.trophies);
  });
}

/* ================= LOGROS ================= */
function renderTrophies(list) {
  const ul = document.getElementById("trophies");
  ul.innerHTML = "";
  list.forEach(t => {
    const li = document.createElement("li");
    li.innerText = trophyNames[t];
    ul.appendChild(li);
  });
}

/* ================= RANKING ================= */
async function loadRanking() {
  const list = document.getElementById("ranking");
  list.innerHTML = "";

  const snap = await db.collection("games")
    .where("finished", "==", true)
    .orderBy("time")
    .limit(10)
    .get();

  snap.forEach(doc => {
    const d = doc.data();
    const li = document.createElement("li");
    li.innerText = `${d.team} - ${d.player} (${d.time}s)`;
    list.appendChild(li);
  });
}

/* ================= CÃMARA ================= */
function startScanner() {
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qr => {
      document.getElementById("qrInput").value = qr;
      scanQR();
    }
  );
}

function stopScanner() {
  if (scanner) scanner.stop();
}
</script>

</body>
</html>
