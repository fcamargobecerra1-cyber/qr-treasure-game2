<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>QR Treasure Hunt</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f4f4;
  text-align: center;
  padding: 30px;
}
input, select, button {
  padding: 10px;
  margin: 6px;
}
#game, #rankingBox {
  display: none;
}
#reader {
  margin: auto;
  width: 300px;
}
</style>
</head>

<body>

<h1>ğŸ´â€â˜ ï¸ Treasure Hunt</h1>

<!-- LOGIN -->
<div id="login">
  <input id="name" placeholder="Jugador"><br>
  <input id="team" placeholder="Equipo"><br>

  <select id="route">
    <option value="">Selecciona ruta</option>
    <option value="A">Ruta A (1 â†’ 5)</option>
    <option value="B">Ruta B (5 â†’ 1)</option>
  </select><br>

  <button onclick="startGame()">Start</button>
</div>

<!-- GAME -->
<div id="game">
  <h2 id="playerInfo"></h2>
  <p id="time">â± 0 s</p>

  <h3>ğŸ“¥ QR manual</h3>
  <input id="qrInput" placeholder="CÃ³digo QR">
  <button onclick="scanQR()">Enviar</button>

  <h3>ğŸ“· CÃ¡mara</h3>
  <div id="reader"></div>
  <button onclick="startScanner()">Activar</button>
  <button onclick="stopScanner()">Detener</button>

  <h3>ğŸ§© Pista</h3>
  <div id="clue"></div>

  <h3>â­ Logros</h3>
  <ul id="trophies"></ul>
</div>

<!-- RANKING -->
<div id="rankingBox">
  <h2>ğŸ† Ranking</h2>
  <ol id="ranking"></ol>
</div>

<script>
/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCnbWVep308i-Bo12xeJJoo_VFPd9RJoOI",
  authDomain: "qr-treasure-game.firebaseapp.com",
  projectId: "qr-treasure-game",
  storageBucket: "qr-treasure-game.firebasestorage.app",
  messagingSenderId: "255665365234",
  appId: "1:255665365234:web:b0d76d1cbd6256849df06b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= VARIABLES ================= */
let player = "";
let team = "";
let route = "";
let startTime = 0;
let finished = false;
let scanner = null;

/* ================= RUTAS ================= */
const ROUTES = {
  A: ["META_1", "META_2", "BONUS_1", "META_FINAL"],
  B: ["META_2", "META_1", "BONUS_1", "META_FINAL"]
};

/* ================= PISTAS ================= */
const clues = {
  META_1: "ğŸŒ³ Busca donde hay Ã¡rboles.",
  META_2: "ğŸ” Ve al lugar mÃ¡s alto.",
  BONUS_1: "âš¡ Bonus: -10 segundos",
  META_FINAL: "ğŸ Â¡Terminaste!"
};

/* ================= LOGROS ================= */
const trophyNames = {
  META_1: "ğŸŒ³ Explorador",
  META_2: "ğŸ” Aventurero",
  BONUS_1: "âš¡ Velocista",
  META_FINAL: "ğŸ CampeÃ³n"
};

/* ================= INICIO ================= */
function startGame() {
  const nameInput = document.getElementById("name");
  const teamInput = document.getElementById("team");
  const routeInput = document.getElementById("route");

  player = nameInput.value.trim();
  team = teamInput.value.trim();
  route = routeInput.value;

  if (!player || !team || !route) {
    alert("Completa todos los campos");
    return;
  }

  startTime = Date.now();

  db.collection("games").doc(player).set({
    player,
    team,
    route,
    trophies: [],
    startTime,
    finished: false,
    time: 0
  });

  document.getElementById("login").style.display = "none";
  document.getElementById("game").style.display = "block";
  document.getElementById("playerInfo").innerText =
    `Jugador: ${player} | Equipo: ${team} | Ruta: ${route}`;

  setInterval(updateTime, 1000);
}

/* ================= TIEMPO ================= */
function updateTime() {
  if (finished) return;
  const seconds = Math.floor((Date.now() - startTime) / 1000);
  document.getElementById("time").innerText = `â± ${seconds} s`;
}

/* ================= ESCANEO ================= */
function scanQR() {
  if (finished) return;

  const qr = document.getElementById("qrInput").value.trim();
  if (!qr) return;

  const ref = db.collection("games").doc(player);

  ref.get().then(doc => {
    const data = doc.data();
    const expected = ROUTES[data.route][data.trophies.length];

    if (qr !== expected) {
      alert("âŒ QR incorrecto para esta ruta");
      return;
    }

    data.trophies.push(qr);

    if (qr === "BONUS_1") startTime -= 10000;

    if (qr === "META_FINAL") {
      finished = true;
      data.finished = true;
      data.time = Math.floor((Date.now() - startTime) / 1000);
      document.getElementById("rankingBox").style.display = "block";
      loadRanking();
    }

    ref.update(data);
    document.getElementById("clue").innerText = clues[qr];
    renderTrophies(data.trophies);
  });
}

/* ================= LOGROS ================= */
function renderTrophies(list) {
  const ul = document.getElementById("trophies");
  ul.innerHTML = "";
  list.forEach(t => {
    const li = document.createElement("li");
    li.innerText = trophyNames[t];
    ul.appendChild(li);
  });
}

/* ================= RANKING ================= */
async function loadRanking() {
  const list = document.getElementById("ranking");
  list.innerHTML = "";

  const snap = await db.collection("games")
    .where("finished", "==", true)
    .orderBy("time")
    .limit(10)
    .get();

  snap.forEach(doc => {
    const d = doc.data();
    const li = document.createElement("li");
    li.innerText = `${d.team} - ${d.player} (${d.time}s)`;
    list.appendChild(li);
  });
}

/* ================= CÃMARA ================= */
function startScanner() {
  scanner = new Html5Qrcode("reader");
  scanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    qr => {
      document.getElementById("qrInput").value = qr;
      scanQR();
    }
  );
}

function stopScanner() {
  if (scanner) scanner.stop();
}
</script>

</body>
</html>
